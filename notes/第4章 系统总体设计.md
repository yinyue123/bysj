第4章 系统总体设计

	本程序使用两块网卡，两块CPU。
	网卡1称作受保护的网卡：IPSec客户端连接此网卡IP进行数据传输，主要用来接收处理客户段发来IKE数据和ESP数据以及ARP数据等，通信为密文数据。网卡2称作未受保护的网卡：主要用于处理ESP数据包解密后的数据和目的网络通信以及ARP数据等，通信为明文数据。
	CPU1称作加密核：用来接收受保护网卡的ESP数据，对ESP密文数据进行解密和完整性校验后，将数据从未受保护的网卡发出去。CPU2称作解密核：用来接收未受保护网卡的明文数据(UDP和TCP数据包)，将数据进行加密并生成校验信息，进行ESP封装后发送给受保护的端口。
	完整流程为：
	4.1 ARP部分
	由于DPDK程序为用户态协议栈，不能利用内核的协议栈，此处需要和上级网关通信，需要获取上级网关的MAC地址，因此需要设计实现ARP协议。DPDK服务端启动后，首先需要在未受保护的网口向上级网关发送ARP请求，以便获取上级网关的MAC地址，上级网关受到ARP请求后回复ARP答复，这样DPDK就获得到了上级网关的MAC地址。DPDK发包时需要封装以太网头，获取上级网关MAC地址后，若下次需要向上级网关发送信息，需要封装以太网帧时，首先将自己的MAC地址封装到原MAC地址，将上级网关的MAC地址封装到目的MAC地址，将协议类型封装到以太网帧的协议类型。DPDK服务端还要回复上级网关发给自己的ARP请求，因为上级网关需要通过每隔一段时间向DPDK服务端发送一个ARP请求来确保该主机存活，并保证DPDK服务端的MAC地址是最新的。
	4.2 客户端以太网帧封装
	IPSec客户端需要获取目的主机的MAC地址，因为DPDK程序IKE部分通过KNI网卡转交给内核。KNI网卡除了转交IKE数据包之外，还可以处理其他数据。当数据到达受保护的网卡后，网卡先判断以太网帧的协议类型，是否为IP类型，若非IP类型则直接转交给内核，因此此处IPSec客户端的ARP数据直接交由内核处理。若以太网帧数据类型为IP，IP头中协议类型为ESP，则DPDK程序继续处理，否则交由KNI网卡转交给内核。DPDK程序接收到ESP数据包时暂时不判断以太网头的原地址和目的地址，发送回复客户端时以太网头的原地址和目的地址必须要正确。因此当收到目的端口为500的UDP包时，为IPSec客户端发送来的IKE数据包，因为需要先要通过IKE建立连接，才能通信传输ESP包，因此可以将IKE数据包以太网帧的原MAC地址和原IP地址记录存储起来，已备回复ESP数据包时封装以太网头。
	4.3 NAT部分
	当ESP数据包解密解封装后，需进行SNAT，将数据包的原IP地址的局域网地址转换为广域网地址，原端口也需要随之改变。进行SNAT时，首先查询是否存在该条流，若不存在则说明此条流为一个新连接，需要在NAT表中插入该流，并为其分配一个广域网端口作为SNAT转换后的目的端口。转换后需要对IP头和UDP或TCP头重新计算校验和，然后通过未受保护的端口发出去。当未受保护的端口收到数据时，查询是否存在该条流，若不存在则直接丢弃，若存在需进行DNAT后，再进行ESP封装加密。此处仅支持UDP和TCP协议的NAT，暂不对ICMP进行NAT处理。
	4.4 IKE部分
	IPSec客户端向DPDK服务端发送IKE请求，被KNI网卡转交到内核后，由StrongSwan进行IKE处理，然后将协商的会话密钥通过PF_KEY协议传给内核，本程序通过libnl库的XFRM框架接受该会话密药，通过进程间共享内存的方式传给DPDK程序。