第5章 报文装包拆包处理

​	5.1 ESP数据包处理
	ESP数据包由安全参数索引（SPI）、序列号（Seq Number），载荷数据、填充、填充长度、下个头、鉴别数据组成。
	SPI为32位，是一个用来确定唯一标示的安全联盟。
	Seq Number为32位，用来避免接受方的重放攻击。
	载荷数据为加密后的数据包，隧道模式会连同IP头一起加密。
	填充（Padding）长度为0-255个字节，隐藏载荷数据长度并将明文扩充到加密长度
	填充长度为8位
	下一个头部标志下一个被加密数据的头部的类型
	鉴别数据在ESP数据包前面的基础上计算出完整性校验值。

	ESP封包处理:
	1.如果是隧道模式，跳过这一步，如果是传输模式，获取IP头部长度和协议类型，以备构造新IP使用。
	2.如果是隧道模式，载荷长度为数据包的长度加上2，因为数据包的IP头信息会被放到ESP头部中，原数据包被封装到ESP包中，头部会被丢弃掉。如果是传输模式，载荷长度为数据包的长度减去IP头长度加上2。填充长度的长度为1和下个头的长度为1，都算在载荷长度中，因此要加2。然后将基于这个长度，将数据扩展到块长度，为最终的载荷长度。填充长度为载荷长度加上IP头长度减去数据包原来的长度。也就是最后数据包填充的长度。
	3.如果数据包总长度（IP头长度+ESP头长度+载荷长度+鉴别）超过数据包最大大小MTU，则数据包要么重组，要么丢弃。本程序中数据包超过MTU选择丢弃。
	4.将数据包扩展填充长度和认证长度，这部分数据为载荷数据，也就是需要加密的部分，接下来对载荷层数据包进行封装。
	5.将原数据包的ttl改为-1，获取原数据包的服务类型(TOS)作为新IP头的TOS。TOS是用来设置IP包的优先级和QoS选项。构造新的IP头。并将协议类型置为ESP类型。
	6.将SPI加入ESP头，将SEQ自加1，加入ESP头
	7.加密内容包含载荷数据(传输模式为去掉IP头的数据，隧道模式为原数据)，填充数据和填充长度，下个头，认证信息，其中数据的倒数第二个字节为填充长度，第一个字节为下个头，填充内容为从1到255的字节码。
	8.IV为AES加密的初始向量，是一个固定长度的输入值，为区块大小，要求他是随机或伪随机数，加密的时候会产生IV位。第一个IV由用户提供，其他IV都是自动生成的。IV放在ESP的SPI和Seq Number之后，IV长度为16，是未加密的，但当做密文的一部分
	9.认证内容从IP头之后开始，到认证尾部(认证结果位置之前)，包含ESP头部和明文载荷数据，明文扩展数据，明文扩展长度，明文下个头，然后选择认证算法，对数据进行认证，并放在数据包最尾部，最后进行加密

	ESP解包处理:
	1.首先计算IP头部长度，载荷数据长度为数据包总长度减去IP头长度再减去IV长度，减去认证长度，使用指定的加密密钥和加密算法对数据进行解密。载荷数据应该为块大小的倍数，并且大于0，否则载荷数据又问题，需要丢弃。
	2.使用IV值，从ESP头部之后(SPI和Seq Number之后)对数据进行解密，认证数据从IP头部之后开始进行解密
	3.对数据进行认证，认证从IP头之后开始，认证的长度包含ESP头(SPI和Seq Number)，IV长度，载荷长度。使用密钥解密数据包中的认证信息，并和计算的认证结果进行对比，判断数据包是否校验通过
	4.对解密后的数据进行处理，获取下个头数据，下个头的位置为数据包的长度减去校验数据长度减下个头长度1。获取填充数据长度，填充数据长度位置为下个头位置减去填充数据长度的长度1。
	5.填充数据位置为填充数据长度的位置减去填充数据长度，对填充数据进行判断，每个填充数据应为填充位置的字节码（从0到255）。如果填充数据不正确，说明数据包有问题，直接丢弃。移除填充数据，填充数据长度，下个头，认证信息
	6.如果是传输模式，将ESP数据包的IP头做为解密后新数据包的头部，新数据包的协议类型改为下个头，IP头长度改为解密后载荷数据的长度
	7.如果是隧道模式，IP头包含载载荷数据中，因此不用单独处理IP头

​	5.2 SADB安全关联数据库
	安全关联数据库的每条信息决定了SA的参数，当IPSec SA被创建，SADB更新所有关于SA的参数，当一个数据包到达时，SADB根据外层IP头部的目的IP地址，SPI和IPSec封装协议（ESP／AH）查询数据库来获取对应的SA，根据SA的参数来确定怎样处理这个IPSec数据包。对于外来IPSec的数据包，则由SPD所关联的SA来获取。

	SA中包含的信息有：
	1.序列号（32位）
	2.序列号溢出位（溢出之后重新开始）
	3.防重放窗口（默认64位）
	4.SA生存时间，有软时间或硬时间，SA到期前一段时间会重新生成新的密钥，从密钥生效到申请密钥这段时间叫软时间
	5.传输模式或隧道模式
	6.ESP验证算法
	7.ESP加密算法
	8.MTU

​	5.3 SPDB安全策略数据库
	选择器会选择指定的流加密，可通过源IP，目的IP，名字，传输协议，源端口号和目的端口号进行选择，并有三种处理方式：1.旁路，保证原封不动 2.丢弃 3.使用IPSec加密

	5.4 NAT算法设计
	NAT概述:随着互联网的发展，用户和设备越来越多，IPv4地址逐渐枯竭，用户数远大于IPv4地址容量。从长远来看，只能更换协议，但更换协议时一个长期的工作，不能一下就完成。短期来看，网络地址转换（NAT）可以较好的解决这一问题。
	NAT将很多个私有IP地址转换为一个或多个公网地址，实现局域网主机和广域网主机的通信。这样就减少了公网地址的分配，实现了IP地址的复用，消减了IP地址空间不足，并且NAT也可以隐藏局域网内部，极大保护了局域网安全。但NAT也存在其不足，NAT针对从内向外部通信，需要局域网主机先向外发出请求，才可处理外部的回复。外网不能直接和内部通信，如需要和内部主机通信，需要使用端口映射或DMZ主机方式，配置较为麻烦。BT下载或者视频通信时需要点对点通信，两个处于局域网间的机器通信将不方便，此时可通过P2P打洞穿透NAT，但这需要NAT支持。

	NAT算法:当数据到来时，首先判断数据包的流向，当源IP和内网IP同在一个网段，目的IP和内网IP不在同一网段时，数据为从内网发向外网的数据，需要SNAT。当源IP和内网IP同在一个网段，目的IP和内网IP在同一个网段，数据是从内网发向内网的数据，需要FORWARD。当源IP和内网IP不在同一个网段，目的IP为外网IP时，查询NAT表中确实存在该条流，数据为外网发向内网的数据，需要做DNAT操作。

	判断是否处于同一网段算法:判断是否处于同一个网段的方法为将两个要判断的IP和子网掩码同时做与操作，与之后的结果相同，则说明两个IP处于同一个网段。

	五元组概念:做NAT时，需要根据五元组在哈希表中查找，五元组为源IP，源端口，目的IP，目的端口，协议类型，可以根据五元组确定唯一一条流，本程序使用uthash作为哈希算法。

	SNAT算法:当做SNAT操作时，首先根据数据包的五元组在内网五元组中查找。若不存在该条数据，说明该数据为一条新的连接，需要为该条流分配一个外网端口，并将内网五元组和外网五元组作为一组放在一起，以备DNAT查询。将数据包的五元组做为内网五元组，而外网五元组的目的IP为外网IP，目的端口需要挑选一个端口，协议类型为数据包的协议类型，源IP为数据包的目的IP，源端口为数据包的目的端口，然后将内网五元组和外网五元组放在一起存到哈希表中。最后将数据包的源IP改为外网IP，将数据包的目的端口改为外网五元组中的目的端口，即分配的那个外网端口。并刷新该数据的存活时间，即将数据包的TTL值改为定义的存活时间。

	分配外网端口算法:分配外网端口的准则为外网五元组不能重复，否则外网五元组不能找到唯一的内网IP和内网端口。从指定的端口范围中随机选取一个，保证生成的五元组和外网五元组中的不重复即可。早期端口号分为三大类，公认端口号从0到1023，用于系统保留使用。注册端口从1024到49151，用于应用程序分配提供公网服务。动态或私有端口从46152到65535，服务不应该分配这些端口，用于操作系统为客户端分配源端口，但现在的操作系统很少遵循该规定，操作系统通常从1024起开始分配动态端口。

	DNAT算法:当做DNAT时，根据数据包的五元组查询外网五元组的哈希表，。若未查到，则无法找到内网IP和端口，会被NAT丢弃。通常这种情况说明内网为发送这样一条流，为外网发向内网的一条流。或内网发送的这条流已经超时被丢弃，nat表中已删除。若HASH表中存在，则将数据包的目的IP改为内网五元组的源IP，目的端口改为内网五元组的源端口。

	NAT表超时算法:NAT的HASH表需要删除超时的流，否则NAT表会越来越大，分配的外网端口也会被使用枯竭。当每次做SNAT后，该条NAT的ttl值会被改为定义的存活时间。定时器会定时将NAT表中的所有ttl值做自减，当值减为0时，说明该记录已超时，会将该条NAT删除。因此不论TCP还是UDP，若要保持长连接，若长时间无通信数据，需要定期发送心跳包。

	5.5 ARP算法设计
	ARP概述:ARP协议全称为地址解析协议，用于实现从IP地址到MAC地址的映射，在网络通信中，数据包在广域网中主要需要根据IP地址进行传输判断，到达路由器后，根据路由表进行转发。而在局域网中，不仅需要IP地址封装，也需要MAC地址的封装，交换机或主机路由器等设备根据ARP表对数据进行转发，普通模式下，若数据包的目的MAC地址不为自己，数据包会被网卡直接丢弃，混杂模式下网卡会收到目的MAC不为自己的数据。ARP协议非常快，实现也很简单，但也最不安全，ARP请求以广播模式在局域网中发送，局域网任何机器都可以进行回复，也可以更改其他机器的ARP表，他没有任何做任何验证处理，因此网络扫描，内网渗透，中间人拦截，流量控制，流量欺骗基本都和ARP协议有关。ARP为根据IP地址解析MAC地址，RARP为根据MAC地址解析IP地址。

	ARP数据包结构:以太网头包含6个字节的源MAC地址，6个字节目的MAC地址，2个字节的协议类型，协议类型为ARP协议。ARP数据包包含2个字节的硬件格式，2个字节的协议地址格式，1个字节的硬件地址长度，1个字节的协议地址长度，2个字节的请求类型（ARP请求或ARP响应），6个字节的发送方MAC，4个字节的发送方IP，6个字节的接收方MAC，4个字节的接收方IP。

	发送ARP请求：通常IPv4的ARP数据包的硬件格式，协议地址格式，硬件地址长度，协议地址长度通常为固定值，若需要查询对方MAC地址，以太网头源地址为本机网卡地址，目的地址为广播地址，ARP数据包中发送方IP和MAC地址为本机网卡中信息，目的IP为要查询的IP，MAC地址置为0。

	处理ARP响应：当发出ARP请求后，目标主机收到会给以响应，响应的数据包以太网头的目的MAC为本机，源MAC为回复的机器，若接收方的MAC地址和IP地址为自己，ARP类型为ARP响应，并且发送方为想要查询的IP，那么发送方的MAC地址则为查询的MAC。当本机发出ARP请求时，目标机会将本机的信息添加到自己的ARP映射表中，然后再予以回复。

	处理ARP请求：对方每发送几个数据包后，都会清空本机器的ARP映射，并发送一个ARP请求，来确保对方主机存活，接收到的数据包为，以太网帧中发送方MAC为本机MAC，接收方MAC为目标机MAC，ARP包中请求类型为ARP请求，发送方MAC和IP为目标机信息，接收方MAC为空，IP为本机IP，我们需要回复的信息为，不修改以太网帧，发送方IP和MAC为本机信息，接收方MAC和IP为目标机。对方收到后会重新刷新ARP映射表。

	5.6 校验值计算

	为了保证数据包的完整性，IP头，TCP头，UDP头，ICMP头等数据包都会通过校验算法生成校验信息。

	IP头校验信息生成算法：
	1.用零将两个字节的校验位置填充
	2.校验的长度为20位IP头，每次取两个字节(16位)的数据进行不断累加，累加的结果存在32位的数中
	3.将累加的结果的高16位和低16位进行相加
	4.将最后相加的结果取反做为校验值

	UDP或TCP校验和计算方法
	1.用零将两个字节的校验位置填充，若数据包长度为奇数，末尾填充一个零
	2.生成伪IP头，伪IP头包含源IP，目的IP，UDP数据长度，一个零字节做为保留位，协议类型
	3.将伪IP头，UDP头，UDP数据放在一起计算校验验和
	4.每次取两个字节(16位)的数据不断累加，累加的结果存在32位的数中
	3.将累加的结果的高16位和低16位进行相加
	4.将最后相加的结果取反做为校验值