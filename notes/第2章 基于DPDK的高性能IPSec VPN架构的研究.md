	本章IPSec几种协议的特点和原理，针对了ESP协议和AH协议展开研究。讨论了密钥交换IKE的几种模式、原理和特点。研究了传统协议栈面临的问题和DPDK用户态协议栈的应对措施和加密加速的解决方案。
2.2 IPSec 综述
	2.2.1 IPSec 处理
	由于IP协议设计之初没有安全保护，数据在传输中有可能被监听或篡改，存在安全隐患。而IPSec是一套完整的加密系统，IPSec有协议提供每个IP数据包的认证，完整性校验（保证传输中未被篡改），机密性（数据包加密）
	IPSec技术主要有AH，ESP，IKE，ISAKMP/Oakley和算法组成。
	AH协议：有完整性校验功能，但不能加密数据。
	ESP协议：有完整性校验功能和加密功能。
	IKE协议：主用于秘钥管理，完成设备间会话秘钥协商和交换。
	加密认证算法：建立连接时需要确定加密和认证的算法，加密常用AES、3DES等算法，认证常用SHA-1和MD5算法。
	SA协议：用于在不同设备间算法协商和秘钥匙交换的概念。
	2.2.2 ESP(封装安全载荷)与AH(验证头)
	ESP主要提供数据加密和完整性校验
	ESP协议：
	加密前数据包：	IP HDR|Data
	加密后数据包：	New IP HDR|Auth(ESP HDR|Enc(IP HDR|Data)|ESP Trailer|ESP Auth)
	隧道和传输模式：
	传输模式：
		IP HDR|Auth(ESP HDR|Enc(Data)|ESP Trailer|ESP Auth)
		仅对IP头部以上的数据进行加密，不对IP头进行加密，主要用于基于IPSec的点对点通用路由协议
	隧道模式：
		New IP Header|Auth(ESP HDR|Enc(IP HDR|Data)|ESP Trailer|ESP Auth)
		首先加密原有数据包，然后加入新头部

	2.2.3 IKE(Internet密钥交换)
	IKE由三部分组成：
	ISAKMP：使用了UDP的500端口，定义了信息交换的体系结构
	SKEME：实现公钥加密认证体制
	Oakley：提供了IPSec对等体间达成相同加密密钥的基本模式机制。
	SA(SecurityAssocation,安全联盟)：用于协商实体通信建立的一种协约，协定了IPSec协议、密钥、转码方式、密钥有效期等。IPSec会构建一个SA数据库（SADB）用来维护IPSec协议保障数据安全。
	SA是单向的：两设备通过ESP进行通信，则设备则需要SA（IN）和SA（OUT），SA（OUT）用作处理发出的数据包，SA（IN）用作处理接受的数据包，SA（IN）和对方的SA（OUT）使用相同的加密参数（密钥等）。
	SA还区分协议，若AH和ESP同时生效，AH和ESP会产生不同的SA。
	SA有两种：
	IKE（ISAKMP） SA：用于协商IKE数据流加密及对等体认证的算法（对密钥加密和peer认证），只能有一个。
	IPSec SA：用于协商对等体之间的IP数据流进行的加密算法，可以有多个。

	IKE交换模式（主模式）
		Peer1										Peer2
		SA交换（用于确认对方使用的算法）
		发送本地IKE策略		---发起方发送策略-->	
		接受对端确认的策略		<--接收方确认策略---		查找匹配的策略
		密钥交换（产生密钥）
						---发起方的密钥生成信息-->		密钥生成
		密钥生成			<--接收方的密钥生成信息---
		ID交换及验证（验证对方身份）
							---发起方身份和验证数据-->	身份验证和交换过程验证
		身份验证和交换过程验证	<--接收方身份和验证数据---
	IKE的交换模式（野蛮模式）
		Peer1										Peer2
		SA交换，密钥生成(确认对方使用的算法，产生密钥)
		发送本地IKE策略，密钥生成信息
					---发起方策略，密钥生成信息-->
											查找匹配的策略，密钥生成
				<--接收方的密钥生成信息，身份和验证数据---
		接收对端确认的策略，密钥生成
		ID交换及验证（验证对方身份）
					--发起方身份和验证数据-->
											身份验证和交换过程验证

		点对点IPSec VPN协商过程有两个阶段，两设备间建立安全的传输连接需要先协商使用的加密算法、密钥、封装技术。
		第一步：两设备间建立安全的管理连接，用作保护加密第二阶段协商过程。
		第二步：协商安全连接的参数，两设备间形成安全连接。
		接下来就可以使用该安全连接来传输数据。

		阶段一ISAKMP SA提供了后续协商的安全，阶段二IPSec SA协商在第一阶段加密保护下进行，IPSec SA为后续传输数据加密。

		阶段一：进行ISAKMP SA协商
			1.协商对等体间认证的方式（共享密钥或数字证书）
			2.协商加密使用的算法（DES或3DES等）
			3.协商认证使用的算法（MD5或SHA）
			4.协商Diffie-Hellman密钥组
			5.协商协商模式（主模式或野蛮模式）
			6.协商SA生存期
		阶段二：进行IPSec SA协商
			1.协商双方封装技术（ESP或AH）
			2.协商加密算法
			3.协商HMAC方式（MD5或SHA）
			4.协商传输模式（传输模式或隧道模式）
			5.协商SA生存期

2.3 XFRM 框架
	XFRM是Linux引入的一种基于策略的高扩展性网络安全架构。在Linux2.6内核中包含了PF_KEY，2.4内核需要打补丁实现。根据RFC2367的定义，内核PF_KEY实现了安全联盟(SA)和安全策略(SP)的数据库以及用户空间接口。不同系统的SA和SP实现管理不同，在Linux内核中则通过xfrm库来实现。

	IPSec的SP：
	SPD用来存放IPSec哪些流量需要走IPSec的规则表，表中包含目的IP，源IP，执行协议(AH或ESP或AH和ESP并存)，源端口，目的端口，工作模式(传输模式或隧道模式)。当主机有数据通过VPN发出的时候，数据包会根据SPD规则进行匹配，只有匹配到，数据包才会通过AH或ESP处理。

	IPSec的SA：
	SAD用来存安全信息，SAD数据库中包含的信息有SPI值，目的端IP，AH或ESP，AH验证算法，AH验证加密密钥，ESP验证算法，ESP验证加密密钥，ESP加密算法，ESP加密密钥，隧道或传输模式。SPI索引值是双方用于索引数据库，手动指定或随机生成的一个值。

2.4 DPDK 平台介绍
	2.4.1 DPDK简介
		DPDK(Data planedevelopment kit)是一个用于处理和加速网络数据包的软件库，相比于传统的Linux操作系统协议栈，DPDK有五个特点：
		1.轮询模式处理数据包：poll-mode网卡驱动轮训检查是否有数据到达，避免了因为中断导致上下文切换的开销，提升了收发报文的效率。虽然该方式会导致CPU一直处于满负荷运行，但却很适合处理不间断大量数据包。当然在特定情况下仍然支持中断。DPDK无锁队列是通过内核kfifo无锁队列完成的。数据使用生产者消费者模型，一对一，一对多，多对多实现入队和出队，不仅保证了数据的同步，也提高了性能。
		2.用户态驱动：传统协议栈在内核态实现，用户态和内核态交换数据需要内存拷贝和系统调用，不必要的消耗很大。使用DPDK可以实现用户态驱动，避免了内存拷贝和系统调用。但用户需自行实现协议栈对数据进行处理和解析。
		3.独占与亲和性：为避免不同核间线程的频繁切换，可以指定某个核心的特定任务，保证cache的更高命中率
		4.降低访问存开销：传统协议栈未充分利用cache和内存，使用Hugepage可以降低TLB miss，使用内存多通道交错访问提高内存访问有效带宽。大页是DPDK通过用户配置，提前在内存预留一块区域，程序可以通过API来申请释放大页，大页最小单位可选2M和1G，并且可选择大页的数量。使用NUMA来访问尽可能靠近CPU的节点内存，跨NUMA节点速度相对较慢。
		5.软件调优：数据预取利用了程序的时间和空间局部性原理，软件预先取，cache行对齐及和burst批量处理多元数据，可以一次将8个、16个甚至32个报文一次处理，这样可以降低访存次数，提高收发包效率。内存池是DPDK巧妙的使用大页技术在用户空间完成的。控制层将数据包扔入内存池，通过指针的方式将控制权转交给下个处理，避免了内存拷贝。

	2.4.2 DPDK加密加速技术
		随着网络带宽的增加，数据的实时加密成为新瓶颈，DPDK提供了多种加密驱动和加密方案:
		AES-NI:AES-NI是Intel和AMD微处理器上x86架构的扩展，从硬件上提高了AES加密速度，目前PC端和服务器的CPU对AES-NI支持普及率很高。DPDK支持aesni-gcm和aesni-mb两种方案。Intel官方公布的数据：开启AES-NI性能比纯软件加密速度提高了5-8倍。
		armv8:在移动端没有AES指令时，谷歌推广使用chacha20加密算法，此算法在同等配置手机中是AES加密算法速度的4倍，随后ARM在ARMv8处理器之后加入了AES指令，AES加密性能反超chacha20。DPDK支持多种硬件加密：AMD加密协处理器ccp、飞思卡尔的硬件加密（caam-jr、dpaa2-sec、dpaa-sec）、mvsam、octeontx、以及英特尔的qat加密加速卡。openssl加密库。除此之外还支持kasumi、snow3g、virtio、zuc等。

	2.4.3 用户态协议栈
		相比于传统的Linux内核协议栈，用户态协议栈优势非常大。数据包到达网卡后会不断产生硬中断，而系统调用和软中断优先级都比硬中断低，产生的消耗比较大。数据包从网卡传送到应用程序需要经历漫长的过程：数据首先要通过DMA方式从网卡传到系统内核指定的缓冲区，之后又要将缓冲区接收到的数据拷贝到用户态空间，该过程时间消耗占到Linux内核处理数据包整个流程的一多半以上。若将数据和控制分离，用户空间只用于管理内存、处理数据包、调度CPU，控制指令交由内核管理，就可以解决用户态和内核态频繁切换的问题。除了频繁软硬中断抢占系统调用产生巨量上下文开销之外，多线程间调度和加锁同样会产生大量上下文切换，DPDK中采用线程与核心对应来减少线程切换，使用无锁队列避免资源竞争。内存页大小为4K。操作系统可以为了提高访存速度，避免页失效，但若增加了缓存数量，查询速度又会随之降低，可以使用大页减少映射数目来防止跨内存访问。
2.5 本章小节
	本章研究了IPSec的ESP协议和AH协议的特点，数据包构造，以及加密算法。并讨论了IPSec密钥交换IKE的两种模式：主模式和野蛮模式。研究了主模式和野蛮模式的优缺点和原理。然后介绍了IPSec应用程序和内核IPSec通信的XFRM框架。最后讨论了DPDK解决传统协议栈中断，锁竞争，线程切换，内存拷贝的方法和加密加速的解决方案。
